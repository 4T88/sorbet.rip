<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sorbet.rip - anonymous imageboard</title>
    <style>
        /* sorbet.rip - minimal 4chan-style theme */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --accent-red: #ff6b6b;
            --accent-red-light: #ff8a8a;
            --border-color: #333333;
            --link-color: #ff6b6b;
            --link-hover: #ff8a8a;
            --quote-color: #4caf50;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e0e0e0;
            --text-primary: #000000;
            --text-secondary: #666666;
            --border-color: #cccccc;
        }

        [data-theme="classic"] {
            --bg-primary: #f0e0d6;
            --bg-secondary: #e6d9d0;
            --bg-tertiary: #d9bfb7;
            --text-primary: #800000;
            --text-secondary: #cc1105;
            --accent-red: #cc1105;
            --accent-red-light: #dd2211;
            --border-color: #d9bfb7;
            --link-color: #cc1105;
            --link-hover: #dd2211;
            --quote-color: #789922;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.4;
            font-size: 14px;
            text-transform: lowercase;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 0;
            margin-bottom: 20px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .site-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-red);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .site-logo {
            width: 24px;
            height: 24px;
            border-radius: 2px;
            background: linear-gradient(45deg, #ff6b6b, #4caf50);
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 12px;
            cursor: pointer;
        }

        nav a:hover {
            color: var(--accent-red);
        }

        .theme-selector {
            position: relative;
        }

        .theme-btn {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            font-family: inherit;
            text-transform: lowercase;
        }

        .theme-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            min-width: 120px;
            z-index: 1000;
            display: none;
        }

        .theme-dropdown.show {
            display: block;
        }

        .theme-option {
            padding: 8px 12px;
            font-size: 11px;
            cursor: pointer;
        }

        .theme-option:hover {
            background-color: var(--bg-tertiary);
        }

        .theme-option.active {
            background-color: var(--accent-red);
            color: var(--bg-primary);
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            min-height: calc(100vh - 120px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .motd {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 20px;
            font-style: italic;
            color: var(--text-secondary);
            text-align: center;
        }

        .boards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .board-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 15px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .board-card:hover {
            border-color: var(--accent-red);
        }

        .board-name {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent-red);
            margin-bottom: 5px;
        }

        .board-title {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .board-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .board-stats {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .board-header, .thread-header {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .board-title-header, .thread-title {
            font-size: 18px;
            color: var(--accent-red);
            font-weight: bold;
        }

        .btn {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
            text-transform: lowercase;
            margin-left: 5px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background-color: var(--accent-red);
            border-color: var(--accent-red);
        }

        .btn-primary {
            background-color: var(--accent-red);
            border-color: var(--accent-red);
        }

        .form-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: none;
        }

        .form-container.show {
            display: block;
        }

        .form-container h3 {
            color: var(--accent-red);
            margin-bottom: 15px;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px;
            font-family: inherit;
            font-size: 12px;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-red);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .threads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .thread-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .thread-card:hover {
            border-color: var(--accent-red);
        }

        .thread-subject {
            font-weight: bold;
            color: var(--accent-red);
            margin-bottom: 8px;
            font-size: 13px;
        }

        .thread-preview {
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.3;
            max-height: 60px;
            overflow: hidden;
        }

        .thread-meta {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .thread-image {
            max-width: 100%;
            max-height: 150px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
        }

        .no-threads {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 40px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .posts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .post {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 15px;
            font-size: 12px;
        }

        .post-header {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .post-number {
            color: var(--accent-red);
            font-weight: bold;
            margin-right: 10px;
        }

        .post-name {
            color: var(--text-primary);
            font-weight: bold;
            margin-right: 10px;
        }

        .post-timestamp {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .post-subject {
            color: var(--accent-red);
            font-weight: bold;
            margin-left: 10px;
        }

        .post-content {
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .post-image {
            max-width: 100%;
            max-height: 400px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .green-text {
            color: var(--quote-color);
        }

        .quote-link {
            color: var(--accent-red);
            text-decoration: none;
        }

        .stats {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 20px;
        }

        .stat-item {
            margin: 0 10px;
        }

        footer {
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 15px 0;
            margin-top: 40px;
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .error, .success {
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            border: 1px solid;
        }

        .error {
            color: var(--accent-red);
            background-color: var(--bg-secondary);
            border-color: var(--accent-red);
        }

        .success {
            color: var(--quote-color);
            background-color: var(--bg-secondary);
            border-color: var(--quote-color);
        }

        .loading {
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .boards-grid {
                grid-template-columns: 1fr;
            }
            
            .board-header, .thread-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .threads-grid {
                grid-template-columns: 1fr;
            }
        }

        .konami-active {
            animation: rainbow 2s infinite;
        }

        @keyframes rainbow {
            0% { background-color: #ff0000; }
            16% { background-color: #ff8000; }
            33% { background-color: #ffff00; }
            50% { background-color: #00ff00; }
            66% { background-color: #0080ff; }
            83% { background-color: #8000ff; }
            100% { background-color: #ff0000; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="site-title" onclick="showHome()">
                <div class="site-logo"></div>
                sorbet.rip
            </div>
            <nav>
                <ul>
                    <li><a onclick="showHome()">home</a></li>
                    <li class="theme-selector">
                        <button class="theme-btn" onclick="toggleThemeDropdown()">theme</button>
                        <div class="theme-dropdown" id="theme-dropdown">
                            <div class="theme-option active" data-theme="dark" onclick="changeTheme('dark')">dark</div>
                            <div class="theme-option" data-theme="light" onclick="changeTheme('light')">light</div>
                            <div class="theme-option" data-theme="classic" onclick="changeTheme('classic')">classic</div>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- Home Page -->
        <div id="home-page" class="page active">
            <div class="motd" id="motd">remember when the internet was good?</div>
            
            <div class="boards-grid" id="boards-grid">
                <div class="board-card" onclick="showBoard('g')">
                    <div class="board-name">/g/</div>
                    <div class="board-title">tech</div>
                    <div class="board-description">technology discussion, programming, hardware</div>
                    <div class="board-stats">loading...</div>
                </div>
                <div class="board-card" onclick="showBoard('b')">
                    <div class="board-name">/b/</div>
                    <div class="board-title">random</div>
                    <div class="board-description">anything goes, the wild west</div>
                    <div class="board-stats">loading...</div>
                </div>
                <div class="board-card" onclick="showBoard('pol')">
                    <div class="board-name">/pol/</div>
                    <div class="board-title">politics</div>
                    <div class="board-description">political discussion and debates</div>
                    <div class="board-stats">loading...</div>
                </div>
                <div class="board-card" onclick="showBoard('rtd')">
                    <div class="board-name">/rtd/</div>
                    <div class="board-title">retards</div>
                    <div class="board-description">laugh at morons, cringe compilation</div>
                    <div class="board-stats">loading...</div>
                </div>
                <div class="board-card" onclick="showBoard('cmp')">
                    <div class="board-name">/cmp/</div>
                    <div class="board-title">complaints</div>
                    <div class="board-description">complaints about life, venting, doomer posting</div>
                    <div class="board-stats">loading...</div>
                </div>
            </div>
            
            <div class="stats">
                <span class="stat-item">posts: <span id="total-posts">0</span></span>
                <span class="stat-item">threads: <span id="total-threads">0</span></span>
                <span class="stat-item">users online: <span id="users-online">1</span></span>
            </div>
        </div>

        <!-- Board Page -->
        <div id="board-page" class="page">
            <div class="board-header">
                <h2 class="board-title-header" id="board-title">/board/</h2>
                <div class="board-actions">
                    <button class="btn btn-primary" onclick="showNewThreadForm()">new thread</button>
                    <button class="btn" onclick="refreshBoard()">refresh</button>
                    <button class="btn" onclick="showHome()">← back</button>
                </div>
            </div>

            <div class="form-container" id="new-thread-form">
                <h3>create new thread</h3>
                <form id="thread-form">
                    <div class="form-group">
                        <label for="subject">subject</label>
                        <input type="text" id="subject" name="subject" required>
                    </div>
                    <div class="form-group">
                        <label for="name">name</label>
                        <input type="text" id="name" name="name" placeholder="anonymous">
                    </div>
                    <div class="form-group">
                        <label for="comment">comment</label>
                        <textarea id="comment" name="comment" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="image">image (optional)</label>
                        <input type="file" id="image" name="image" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary">create thread</button>
                    <button type="button" class="btn" onclick="hideNewThreadForm()">cancel</button>
                </form>
            </div>

            <div class="threads-grid" id="threads-grid"></div>
        </div>

        <!-- Thread Page -->
        <div id="thread-page" class="page">
            <div class="thread-header">
                <h2 class="thread-title" id="thread-title">thread title</h2>
                <div class="thread-actions">
                    <button class="btn btn-primary" onclick="showReplyForm()">reply</button>
                    <button class="btn" onclick="refreshThread()">refresh</button>
                    <button class="btn" onclick="goBackToBoard()">← back to board</button>
                </div>
            </div>

            <div class="form-container" id="reply-form">
                <h3>post reply</h3>
                <form id="post-form">
                    <div class="form-group">
                        <label for="reply-name">name</label>
                        <input type="text" id="reply-name" name="name" placeholder="anonymous">
                    </div>
                    <div class="form-group">
                        <label for="reply-comment">comment</label>
                        <textarea id="reply-comment" name="comment" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="reply-image">image (optional)</label>
                        <input type="file" id="reply-image" name="image" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary">post reply</button>
                    <button type="button" class="btn" onclick="hideReplyForm()">cancel</button>
                </form>
            </div>

            <div class="posts-list" id="posts-list"></div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <span class="footer-text">sorbet.rip - anonymous imageboard</span>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // Global variables
        var currentPage = 'home';
        var currentBoard = null;
        var currentThread = null;
        var db = null;
        var unsubscribes = [];
        var konamiSequence = [];
        var konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];
        
        var motdQuotes = [
            "remember when the internet was good?",
            "tfw no gf posting never gets old",
            "sage goes in all fields",
            "newfags can't triforce",
            "op is a bundle of sticks as always",
            "checked and kekpilled",
            "digits confirm it",
            "autism speaks and it says buy crypto",
            "another day, another seethe thread",
            "imagine not using an imageboard in 2025",
            "this thread is now diamonds",
            "moot was right about everything",
            "feels good man dot jpeg",
            "based and anonymous-pilled",
            "lurk moar, post less",
            "the oldfags were right",
            "normalfags ruined the internet",
            "we're all gonna make it brah",
            "op can't into basic computer usage",
            "it's ogre"
        ];

        var boards = {
            'g': { id: 'g', name: '/g/', title: 'tech', description: 'technology discussion, programming, hardware' },
            'b': { id: 'b', name: '/b/', title: 'random', description: 'anything goes, the wild west' },
            'pol': { id: 'pol', name: '/pol/', title: 'politics', description: 'political discussion and debates' },
            'rtd': { id: 'rtd', name: '/rtd/', title: 'retards', description: 'laugh at morons, cringe compilation' },
            'cmp': { id: 'cmp', name: '/cmp/', title: 'complaints', description: 'complaints about life, venting, doomer posting' }
        };

        // Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyChvzhkNdNOgBfKiPEbH3MnDBpgovK0IM4",
            authDomain: "sorbet-e9f95.firebaseapp.com",
            projectId: "sorbet-e9f95",
            storageBucket: "sorbet-e9f95.firebasestorage.app",
            messagingSenderId: "900130554084",
            appId: "1:900130554084:web:941c3c0ec5c7365f60ecf1",
            measurementId: "G-4KTJN2F7Q1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatTime(timestamp) {
            var date = new Date(timestamp);
            var now = new Date();
            var diff = now - date;
            
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            return date.toLocaleDateString();
        }

        function formatContent(content) {
            if (!content) return '';
            
            // Green text (lines starting with >)
            content = content.replace(/^>(.*)$/gm, '<span class="green-text">>$1</span>');
            
            // Quote links (>>postnumber)
            content = content.replace(/>>(\w+)/g, '<a href="#post-$1" class="quote-link">>>$1</a>');
            
            // Bold text (**text**)
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic text (*text*)
            content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Code blocks (`text`)
            content = content.replace(/`(.*?)`/g, '<code>$1</code>');
            
            // Convert newlines to <br>
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        function fileToBase64(file) {
            return new Promise(function(resolve, reject) {
                var reader = new FileReader();
                reader.onload = function() { resolve(reader.result); };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Page navigation
        function showPage(pageId) {
            // Clean up any existing listeners
            unsubscribes.forEach(function(unsubscribe) {
                unsubscribe();
            });
            unsubscribes = [];

            var pages = document.querySelectorAll('.page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].classList.remove('active');
            }
            document.getElementById(pageId).classList.add('active');
            currentPage = pageId.replace('-page', '');
        }

        function showHome() {
            showPage('home-page');
            loadBoards();
            displayMOTD();
            updateStats();
        }

        function showBoard(boardId) {
            currentBoard = boardId;
            showPage('board-page');
            loadBoard(boardId);
        }

        function showThread(threadId) {
            currentThread = threadId;
            showPage('thread-page');
            loadThread(threadId);
        }

        function goBackToBoard() {
            if (currentBoard) {
                showBoard(currentBoard);
            } else {
                showHome();
            }
        }

        // Display functions
        function displayMOTD() {
            var motd = document.getElementById('motd');
            var randomQuote = motdQuotes[Math.floor(Math.random() * motdQuotes.length)];
            motd.textContent = randomQuote;
        }

        function updateStats() {
            if (!db) {
                document.getElementById('total-posts').textContent = '0';
                document.getElementById('total-threads').textContent = '0';
                document.getElementById('users-online').textContent = '1';
                return;
            }

            db.collection('threads').get().then(function(threadsSnapshot) {
                document.getElementById('total-threads').textContent = threadsSnapshot.size;
            }).catch(function(error) {
                console.error('Error updating thread stats:', error);
                document.getElementById('total-threads').textContent = '0';
            });

            db.collection('posts').get().then(function(postsSnapshot) {
                document.getElementById('total-posts').textContent = postsSnapshot.size;
            }).catch(function(error) {
                console.error('Error updating post stats:', error);
                document.getElementById('total-posts').textContent = '0';
            });
            
            document.getElementById('users-online').textContent = Math.floor(Math.random() * 10) + 1;
        }

        function loadBoards() {
            if (!db) {
                console.error('Firebase not initialized');
                return;
            }

            // Update board stats
            Object.keys(boards).forEach(function(boardId) {
                var board = boards[boardId];
                
                db.collection('threads').where('boardId', '==', boardId).get().then(function(threadsSnapshot) {
                    db.collection('posts').where('boardId', '==', boardId).get().then(function(postsSnapshot) {
                        // Find the board card and update stats
                        var boardCards = document.querySelectorAll('.board-card');
                        for (var i = 0; i < boardCards.length; i++) {
                            var nameEl = boardCards[i].querySelector('.board-name');
                            if (nameEl && nameEl.textContent === board.name) {
                                var statsEl = boardCards[i].querySelector('.board-stats');
                                if (statsEl) {
                                    statsEl.textContent = threadsSnapshot.size + ' threads, ' + postsSnapshot.size + ' posts';
                                }
                                break;
                            }
                        }
                    });
                }).catch(function(error) {
                    console.error('Error loading board stats:', error);
                });
            });
        }

        function loadBoard(boardId) {
            var board = boards[boardId];
            if (!board) return;

            document.getElementById('board-title').textContent = board.name + ' ' + board.title;
            
            var grid = document.getElementById('threads-grid');
            grid.innerHTML = '<div class="loading">loading threads...</div>';

            if (!db) {
                grid.innerHTML = '<div class="error">firebase not initialized</div>';
                return;
            }

            try {
                var threadsQuery = db.collection('threads')
                    .where('boardId', '==', boardId)
                    .orderBy('lastBump', 'desc');

                var unsubscribe = threadsQuery.onSnapshot(function(snapshot) {
                    grid.innerHTML = '';
                    
                    if (snapshot.empty) {
                        grid.innerHTML = '<div class="no-threads">no threads yet. be the first to post!</div>';
                        return;
                    }

                    snapshot.docs.forEach(function(doc) {
                        var thread = { id: doc.id };
                        var data = doc.data();
                        Object.keys(data).forEach(function(key) {
                            thread[key] = data[key];
                        });
                        
                        // Get first post for preview
                        db.collection('posts')
                            .where('threadId', '==', thread.id)
                            .orderBy('timestamp', 'asc')
                            .limit(1)
                            .get()
                            .then(function(postsSnapshot) {
                                if (!postsSnapshot.empty) {
                                    var firstPost = { id: postsSnapshot.docs[0].id };
                                    var postData = postsSnapshot.docs[0].data();
                                    Object.keys(postData).forEach(function(key) {
                                        firstPost[key] = postData[key];
                                    });
                                    
                                    // Get reply count
                                    db.collection('posts').where('threadId', '==', thread.id).get().then(function(allPosts) {
                                        var card = document.createElement('div');
                                        card.className = 'thread-card';
                                        card.onclick = function() { showThread(thread.id); };
                                        
                                        var preview = firstPost.comment.substring(0, 200);
                                        if (firstPost.comment.length > 200) preview += '...';
                                        
                                        card.innerHTML = 
                                            '<div class="thread-subject">' + (thread.subject || 'no subject') + '</div>' +
                                            '<div class="thread-preview">' + formatContent(preview) + '</div>' +
                                            '<div class="thread-meta">' + allPosts.size + ' replies • ' + formatTime(thread.timestamp) + '</div>' +
                                            (firstPost.image ? '<img class="thread-image" src="' + firstPost.image + '" alt="thread image">' : '');
                                        
                                        grid.appendChild(card);
                                    });
                                }
                            })
                            .catch(function(error) {
                                console.error('Error loading posts for thread:', error);
                            });
                    });
                }, function(error) {
                    console.error('Error listening to threads:', error);
                    grid.innerHTML = '<div class="error">failed to load threads</div>';
                });

                unsubscribes.push(unsubscribe);
            } catch (error) {
                console.error('Error loading board:', error);
                grid.innerHTML = '<div class="error">failed to load threads</div>';
            }
        }

        function loadThread(threadId) {
            if (!db) {
                document.getElementById('posts-list').innerHTML = '<div class="error">firebase not initialized</div>';
                return;
            }

            try {
                // Get thread data
                db.collection('threads').doc(threadId).get().then(function(threadDoc) {
                    if (!threadDoc.exists) {
                        showError('thread not found');
                        return;
                    }
                    
                    var thread = { id: threadDoc.id };
                    var threadData = threadDoc.data();
                    Object.keys(threadData).forEach(function(key) {
                        thread[key] = threadData[key];
                    });
                    
                    document.getElementById('thread-title').textContent = thread.subject || 'no subject';
                    
                    var list = document.getElementById('posts-list');
                    list.innerHTML = '<div class="loading">loading posts...</div>';

                    // Set up real-time listener for posts
                    var postsQuery = db.collection('posts')
                        .where('threadId', '==', threadId)
                        .orderBy('timestamp', 'asc');

                    var unsubscribe = postsQuery.onSnapshot(function(snapshot) {
                        list.innerHTML = '';
                        
                        if (snapshot.empty) {
                            list.innerHTML = '<div class="loading">no posts yet</div>';
                            return;
                        }
                        
                        snapshot.docs.forEach(function(doc, index) {
                            var post = { id: doc.id };
                            var postData = doc.data();
                            Object.keys(postData).forEach(function(key) {
                                post[key] = postData[key];
                            });
                            
                            var postEl = document.createElement('div');
                            postEl.className = 'post';
                            postEl.id = 'post-' + post.id;
                            
                            var isOP = index === 0;
                            postEl.innerHTML = 
                                '<div class="post-header">' +
                                '<span class="post-number">#' + post.id + '</span>' +
                                '<span class="post-name">' + (post.name || 'anonymous') + '</span>' +
                                '<span class="post-timestamp">' + formatTime(post.timestamp) + '</span>' +
                                (isOP && post.subject ? '<span class="post-subject">' + post.subject + '</span>' : '') +
                                '</div>' +
                                '<div class="post-content">' + formatContent(post.comment) + '</div>' +
                                (post.image ? '<img class="post-image" src="' + post.image + '" alt="attached image" onclick="this.style.maxHeight = this.style.maxHeight === \'none\' ? \'400px\' : \'none\'">' : '');
                            
                            list.appendChild(postEl);
                        });
                    }, function(error) {
                        console.error('Error listening to posts:', error);
                        list.innerHTML = '<div class="error">failed to load posts</div>';
                    });

                    unsubscribes.push(unsubscribe);
                }).catch(function(error) {
                    console.error('Error loading thread:', error);
                    document.getElementById('posts-list').innerHTML = '<div class="error">failed to load posts</div>';
                });
            } catch (error) {
                console.error('Error loading thread:', error);
                document.getElementById('posts-list').innerHTML = '<div class="error">failed to load posts</div>';
            }
        }

        // Form handling
        function handleThreadSubmit(e) {
            e.preventDefault();
            var formData = new FormData(e.target);
            
            if (!currentBoard || !db) {
                showError('invalid board or firebase not initialized');
                return;
            }

            var threadData = {
                boardId: currentBoard,
                subject: formData.get('subject') || '',
                timestamp: Date.now(),
                lastBump: Date.now(),
                postCount: 1
            };

            var postData = {
                boardId: currentBoard,
                name: formData.get('name') || 'anonymous',
                comment: formData.get('comment') || '',
                subject: formData.get('subject') || '',
                timestamp: Date.now(),
                image: null
            };

            var imageFile = formData.get('image');
            if (imageFile && imageFile.size > 0) {
                if (imageFile.size > 5 * 1024 * 1024) {
                    showError('image too large (max 5mb)');
                    return;
                }
                
                fileToBase64(imageFile).then(function(base64) {
                    postData.image = base64;
                    createThreadAndPost();
                }).catch(function(error) {
                    console.error('Error converting image:', error);
                    showError('failed to process image');
                });
            } else {
                createThreadAndPost();
            }

            function createThreadAndPost() {
                db.collection('threads').add(threadData).then(function(threadRef) {
                    postData.threadId = threadRef.id;
                    return db.collection('posts').add(postData);
                }).then(function() {
                    showThread(postData.threadId);
                    showSuccess('thread created successfully');
                    e.target.reset();
                    hideNewThreadForm();
                }).catch(function(error) {
                    console.error('Error creating thread:', error);
                    showError('failed to create thread');
                });
            }
        }

        function handlePostSubmit(e) {
            e.preventDefault();
            var formData = new FormData(e.target);
            
            if (!currentThread || !db) {
                showError('invalid thread or firebase not initialized');
                return;
            }

            // Get current thread for boardId
            db.collection('threads').doc(currentThread).get().then(function(threadDoc) {
                if (!threadDoc.exists) {
                    showError('thread not found');
                    return;
                }
                var thread = threadDoc.data();

                var postData = {
                    threadId: currentThread,
                    boardId: thread.boardId,
                    name: formData.get('name') || 'anonymous',
                    comment: formData.get('comment') || '',
                    timestamp: Date.now(),
                    image: null
                };

                var imageFile = formData.get('image');
                if (imageFile && imageFile.size > 0) {
                    if (imageFile.size > 5 * 1024 * 1024) {
                        showError('image too large (max 5mb)');
                        return;
                    }
                    
                    fileToBase64(imageFile).then(function(base64) {
                        postData.image = base64;
                        createPost();
                    }).catch(function(error) {
                        console.error('Error converting image:', error);
                        showError('failed to process image');
                    });
                } else {
                    createPost();
                }

                function createPost() {
                    db.collection('posts').add(postData).then(function() {
                        // Update thread bump
                        return db.collection('threads').doc(currentThread).update({
                            lastBump: Date.now(),
                            postCount: firebase.firestore.FieldValue.increment(1)
                        });
                    }).then(function() {
                        showSuccess('reply posted');
                        e.target.reset();
                        hideReplyForm();
                    }).catch(function(error) {
                        console.error('Error creating post:', error);
                        showError('failed to post reply');
                    });
                }
            }).catch(function(error) {
                console.error('Error getting thread:', error);
                showError('failed to get thread info');
            });
        }

        // UI functions
        function showNewThreadForm() {
            document.getElementById('new-thread-form').classList.add('show');
        }

        function hideNewThreadForm() {
            document.getElementById('new-thread-form').classList.remove('show');
        }

        function showReplyForm() {
            document.getElementById('reply-form').classList.add('show');
        }

        function hideReplyForm() {
            document.getElementById('reply-form').classList.remove('show');
        }

        function refreshBoard() {
            if (currentBoard) {
                loadBoard(currentBoard);
            }
        }

        function refreshThread() {
            if (currentThread) {
                loadThread(currentThread);
            }
        }

        function toggleThemeDropdown() {
            document.getElementById('theme-dropdown').classList.toggle('show');
        }

        function changeTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            localStorage.setItem('sorbet-theme', themeName);
            
            var themeOptions = document.querySelectorAll('.theme-option');
            for (var i = 0; i < themeOptions.length; i++) {
                themeOptions[i].classList.remove('active');
                if (themeOptions[i].getAttribute('data-theme') === themeName) {
                    themeOptions[i].classList.add('active');
                }
            }
            
            document.getElementById('theme-dropdown').classList.remove('show');
        }

        function loadTheme() {
            var savedTheme = localStorage.getItem('sorbet-theme') || 'dark';
            changeTheme(savedTheme);
        }

        function showError(message) {
            var errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.body.firstChild);
            
            setTimeout(function() {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            var successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.body.insertBefore(successDiv, document.body.firstChild);
            
            setTimeout(function() {
                successDiv.remove();
            }, 3000);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load theme
            loadTheme();
            
            // Show home page
            showHome();
            
            // Form event listeners
            var threadForm = document.getElementById('thread-form');
            if (threadForm) {
                threadForm.addEventListener('submit', handleThreadSubmit);
            }

            var postForm = document.getElementById('post-form');
            if (postForm) {
                postForm.addEventListener('submit', handlePostSubmit);
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Konami code
                konamiSequence.push(e.code);
                if (konamiSequence.length > konamiCode.length) {
                    konamiSequence.shift();
                }
                if (konamiSequence.join(',') === konamiCode.join(',')) {
                    document.body.classList.add('konami-active');
                    showSuccess('you found the konami code!');
                    setTimeout(function() {
                        document.body.classList.remove('konami-active');
                    }, 5000);
                }

                // Regular shortcuts
                if (e.ctrlKey) {
                    switch (e.key) {
                        case 'r':
                            e.preventDefault();
                            if (currentPage === 'board') refreshBoard();
                            else if (currentPage === 'thread') refreshThread();
                            break;
                        case 'n':
                            e.preventDefault();
                            if (currentPage === 'board') showNewThreadForm();
                            else if (currentPage === 'thread') showReplyForm();
                            break;
                    }
                } else if (e.key === 'Escape') {
                    hideNewThreadForm();
                    hideReplyForm();
                    document.getElementById('theme-dropdown').classList.remove('show');
                }
            });

            // Click outside to close dropdowns
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.theme-selector')) {
                    document.getElementById('theme-dropdown').classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
